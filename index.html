<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×”×—×©×‘×•×Ÿ ×©×œ ×™×”×œ×™</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Varela Round', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(160deg, #5b4d8e 0%, #7b6bb8 35%, #9d7dc9 60%, #c99cc8 85%, #f0c4e4 100%);
      padding: 24px;
      transition: background 0.5s ease;
    }
    body.correct {
      background: linear-gradient(160deg, #0d7a6f 0%, #11998e 40%, #38ef7d 100%);
    }
    body.wrong {
      animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-10px); }
      40% { transform: translateX(10px); }
      60% { transform: translateX(-8px); }
      80% { transform: translateX(8px); }
    }
    .screen {
      display: none;
      width: 100%;
      max-width: 440px;
      text-align: center;
      animation: fadeIn 0.4s ease;
    }
    .screen.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.97); }
      to { opacity: 1; transform: scale(1); }
    }
    .card {
      background: rgba(255,255,255,0.18);
      backdrop-filter: blur(12px);
      border-radius: 28px;
      padding: 28px;
      border: 1px solid rgba(255,255,255,0.35);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    /* ××¡×š ×¤×ª×™×—×” */
    .welcome h1 {
      font-size: 2.5rem;
      color: #fff;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.2);
      margin-bottom: 0.5rem;
      line-height: 1.3;
      letter-spacing: 0.02em;
    }
    .welcome .sub {
      font-size: 1.25rem;
      color: rgba(255,255,255,0.95);
      margin-bottom: 1.5rem;
    }
    .btn-start {
      font-family: 'Varela Round', sans-serif;
      font-size: 1.75rem;
      padding: 18px 48px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(145deg, #ffd93d 0%, #ffb347 50%, #ff9f43 100%);
      color: #4a3512;
      cursor: pointer;
      box-shadow: 0 6px 0 #c77a0e, 0 10px 28px rgba(0,0,0,0.22);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 0 #c77a0e, 0 14px 32px rgba(0,0,0,0.28);
    }
    .btn-start:active {
      transform: translateY(4px);
      box-shadow: 0 2px 0 #c77a0e, 0 4px 14px rgba(0,0,0,0.2);
    }
    .timer-toggle {
      font-family: 'Varela Round', sans-serif;
      font-size: 1.05rem;
      padding: 11px 20px;
      border: 2px solid rgba(255,255,255,0.75);
      border-radius: 26px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .timer-toggle:hover {
      background: rgba(255,255,255,0.35);
      border-color: rgba(255,255,255,0.95);
    }
    .timer-toggle.on {
      background: rgba(56, 239, 125, 0.45);
      border-color: rgba(56, 239, 125, 0.9);
      box-shadow: 0 2px 14px rgba(56, 239, 125, 0.3);
    }
    .timer-settings {
      display: inline-flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .timer-duration {
      font-family: 'Varela Round', sans-serif;
      font-size: 0.95rem;
      padding: 8px 14px;
      border: 2px solid rgba(255,255,255,0.75);
      border-radius: 20px;
      background: rgba(255,255,255,0.25);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .timer-duration option { background: #4a3d6e; color: #fff; }
    .timer-duration.hidden { display: none; }
    /* ×¨××ª ×§×•×©×™ */
    .difficulty-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 1.25rem;
    }
    .difficulty-btn {
      font-family: 'Varela Round', sans-serif;
      font-size: 1rem;
      padding: 10px 18px;
      border: 2px solid rgba(255,255,255,0.7);
      border-radius: 22px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .difficulty-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    .difficulty-btn.active {
      background: rgba(255,255,255,0.45);
      border-color: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
    }
    /* ××¡×š ×ª×¨×’×™×œ */
    .streak-box {
      background: rgba(255,255,255,0.28);
      border-radius: 22px;
      padding: 10px 18px;
      font-size: 1.15rem;
      color: #fff;
      display: inline-block;
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }
    .streak-box span {
      font-weight: bold;
      font-size: 1.35rem;
    }
    .game-top {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 1.25rem;
    }
    .timer-box {
      background: rgba(255,255,255,0.3);
      border-radius: 22px;
      padding: 10px 18px;
      font-size: 1.35rem;
      color: #fff;
      direction: ltr;
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }
    .timer-box.low { background: rgba(255, 150, 50, 0.6); }
    .timer-box.urgent { background: rgba(255, 80, 80, 0.6); animation: pulse-timer 0.8s ease infinite; }
    @keyframes pulse-timer {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .timer-box.hidden { display: none; }
    .exercise-wrap {
      background: rgba(255,255,255,0.2);
      border-radius: 24px;
      padding: 1.5rem 2rem;
      margin: 1.25rem 0 1.5rem;
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: inset 0 2px 12px rgba(255,255,255,0.15), 0 6px 20px rgba(0,0,0,0.1);
    }
    .exercise-text {
      font-size: 3rem;
      color: #fff;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.25);
      letter-spacing: 3px;
      direction: ltr;
    }
    .answers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 0.5rem;
    }
    .answer-btn {
      font-family: 'Varela Round', sans-serif;
      font-size: 1.6rem;
      padding: 22px 16px;
      border: 2px solid rgba(255,255,255,0.7);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0.2) 100%);
      color: #fff;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .answer-btn:hover {
      background: linear-gradient(180deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.3) 100%);
      transform: scale(1.02);
      border-color: rgba(255,255,255,0.95);
      box-shadow: 0 6px 22px rgba(0,0,0,0.15);
    }
    .answer-btn:active {
      transform: scale(0.98);
    }
    .answer-btn.wrong-choice {
      background: rgba(255, 80, 80, 0.6);
      border-color: #ff4444;
      animation: pulse-red 0.3s ease;
    }
    @keyframes pulse-red {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    /* ××¡×š ×¦×•×“×§ */
    .result-screen .emoji {
      font-size: 5rem;
      margin: 1rem 0;
      animation: bounce 0.6s ease;
    }
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    .result-screen h2 {
      font-size: 2rem;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      margin-bottom: 1rem;
    }
    .result-screen .next-btn {
      font-family: 'Varela Round', sans-serif;
      font-size: 1.4rem;
      margin-top: 1.5rem;
      padding: 14px 42px;
      border: none;
      border-radius: 28px;
      background: linear-gradient(145deg, #fff 0%, #e8f8f5 100%);
      color: #0d7a6f;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 18px rgba(0,0,0,0.18);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .result-screen .next-btn:hover {
      transform: scale(1.04);
      box-shadow: 0 6px 22px rgba(0,0,0,0.22);
    }
    .wrong-encourage {
      font-size: 1.3rem;
      color: #fff;
      margin-top: 0.5rem;
    }
    .btn-restart {
      font-family: 'Varela Round', sans-serif;
      font-size: 1rem;
      margin-top: 1.5rem;
      padding: 11px 22px;
      border: 2px solid rgba(255,255,255,0.65);
      border-radius: 24px;
      background: rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.98);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .btn-restart:hover {
      background: rgba(255,255,255,0.25);
      border-color: rgba(255,255,255,0.85);
    }

    .confetti-container {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 100;
    }
    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -20px;
      animation: confetti-fall 3.5s ease-out forwards;
    }
    .confetti-piece.square { border-radius: 0; }
    .confetti-piece.circle { border-radius: 50%; }
    .confetti-piece.rect { width: 14px; height: 7px; }
    @keyframes confetti-fall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0.3;
      }
    }
  </style>
</head>
<body>
  <!-- ××¡×š ×¤×ª×™×—×” -->
  <section id="welcome" class="screen active welcome">
    <div class="card">
      <h1>ğŸŒˆ ×”×—×©×‘×•×Ÿ ×©×œ ×™×”×œ×™ ğŸŒˆ</h1>
      <p class="sub">×‘×•× × ×ª×××Ÿ ×‘×—×©×‘×•×Ÿ!</p>
      <p class="difficulty-label" style="font-size:1rem;color:rgba(255,255,255,0.9);margin-bottom:8px;">×¨××ª ×§×•×©×™</p>
      <div class="difficulty-row">
        <button type="button" class="difficulty-btn" data-level="easy">×§×œ</button>
        <button type="button" class="difficulty-btn active" data-level="medium">×‘×™× ×•× ×™</button>
        <button type="button" class="difficulty-btn" data-level="hard">×§×©×”</button>
      </div>
      <div class="timer-settings">
        <button type="button" class="timer-toggle" aria-pressed="false">â± ×”×•×¡×£ ×˜×™×™××¨</button>
        <select class="timer-duration hidden" aria-label="××©×š ×”×˜×™×™××¨">
          <option value="15">15 ×©× ×™×•×ª</option>
          <option value="20">20 ×©× ×™×•×ª</option>
          <option value="30" selected>30 ×©× ×™×•×ª</option>
          <option value="45">45 ×©× ×™×•×ª</option>
          <option value="60">×“×§×”</option>
          <option value="90">×“×§×” ×•×—×¦×™</option>
          <option value="120">2 ×“×§×•×ª</option>
          <option value="180">3 ×“×§×•×ª</option>
          <option value="240">4 ×“×§×•×ª</option>
          <option value="300">5 ×“×§×•×ª</option>
        </select>
      </div>
      <button type="button" class="btn-start" id="btnStart">×”×ª×—×œ</button>
    </div>
  </section>

  <!-- ××¡×š ×ª×¨×’×™×œ -->
  <section id="game" class="screen game">
    <div class="card">
      <div class="game-top">
        <div class="streak-box">ğŸ”¥ ×¨×¦×£: <span id="streakCount">0</span></div>
        <div id="timerBox" class="timer-box hidden">â± <span id="timerNum">30</span></div>
        <div class="timer-settings">
          <button type="button" class="timer-toggle" aria-pressed="false">â± ×˜×™×™××¨</button>
          <select class="timer-duration hidden" aria-label="××©×š ×”×˜×™×™××¨">
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="30" selected>30</option>
            <option value="45">45</option>
            <option value="60">60</option>
            <option value="90">90</option>
            <option value="120">2 ×“×§'</option>
            <option value="180">3 ×“×§'</option>
            <option value="240">4 ×“×§'</option>
            <option value="300">5 ×“×§'</option>
          </select>
        </div>
      </div>
      <div class="exercise-wrap">
        <div class="exercise-text" id="exerciseText">23 + 5</div>
      </div>
      <div class="answers" id="answersContainer"></div>
      <button type="button" class="btn-restart">ğŸ  ×”×ª×—×œ ××”×”×ª×—×œ×”</button>
    </div>
    <div class="difficulty-row" style="margin-top:14px;">
      <span style="color:rgba(255,255,255,0.85);font-size:0.95rem;">×¨××”:</span>
      <button type="button" class="difficulty-btn" data-level="easy">×§×œ</button>
      <button type="button" class="difficulty-btn active" data-level="medium">×‘×™× ×•× ×™</button>
      <button type="button" class="difficulty-btn" data-level="hard">×§×©×”</button>
    </div>
  </section>

  <!-- ××¡×š ×ª×©×•×‘×” × ×›×•× ×” -->
  <section id="correctScreen" class="screen result-screen">
    <div class="card">
      <div class="emoji">ğŸ‰ ğŸŒŸ ğŸ‰</div>
      <h2>×›×œ ×”×›×‘×•×“ ×™×”×œ×™!</h2>
      <p class="wrong-encourage">××¦×•×™×Ÿ!</p>
      <div class="timer-settings" style="margin-top: 1rem;">
        <button type="button" class="timer-toggle" aria-pressed="false">â± ×˜×™×™××¨</button>
        <select class="timer-duration hidden" aria-label="××©×š ×”×˜×™×™××¨">
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="30" selected>30</option>
          <option value="45">45</option>
          <option value="60">60</option>
          <option value="90">90</option>
          <option value="120">2 ×“×§'</option>
          <option value="180">3 ×“×§'</option>
          <option value="240">4 ×“×§'</option>
          <option value="300">5 ×“×§'</option>
        </select>
      </div>
      <button type="button" class="next-btn" id="btnNextCorrect">×”×‘× â†’</button>
      <button type="button" class="btn-restart">ğŸ  ×”×ª×—×œ ××”×”×ª×—×œ×”</button>
    </div>
    <div class="difficulty-row" style="margin-top:14px;">
      <button type="button" class="difficulty-btn" data-level="easy">×§×œ</button>
      <button type="button" class="difficulty-btn active" data-level="medium">×‘×™× ×•× ×™</button>
      <button type="button" class="difficulty-btn" data-level="hard">×§×©×”</button>
    </div>
  </section>

  <!-- ××¡×š ×ª×©×•×‘×” ×©×’×•×™×” -->
  <section id="wrongScreen" class="screen result-screen">
    <div class="card">
      <div class="emoji">ğŸ’ª ğŸ˜Š</div>
      <h2>×›××¢×˜! × ×¡×” ×©×•×‘</h2>
      <p class="wrong-encourage">××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ â€“ ××ª×” ×™×›×•×œ!</p>
      <div class="timer-settings" style="margin-top: 1rem;">
        <button type="button" class="timer-toggle" aria-pressed="false">â± ×˜×™×™××¨</button>
        <select class="timer-duration hidden" aria-label="××©×š ×”×˜×™×™××¨">
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="30" selected>30</option>
          <option value="45">45</option>
          <option value="60">60</option>
          <option value="90">90</option>
          <option value="120">2 ×“×§'</option>
          <option value="180">3 ×“×§'</option>
          <option value="240">4 ×“×§'</option>
          <option value="300">5 ×“×§'</option>
        </select>
      </div>
      <button type="button" class="next-btn" id="btnNextWrong">× ×¡×” ×©×•×‘</button>
      <button type="button" class="btn-restart">ğŸ  ×”×ª×—×œ ××”×”×ª×—×œ×”</button>
    </div>
    <div class="difficulty-row" style="margin-top:14px;">
      <button type="button" class="difficulty-btn" data-level="easy">×§×œ</button>
      <button type="button" class="difficulty-btn active" data-level="medium">×‘×™× ×•× ×™</button>
      <button type="button" class="difficulty-btn" data-level="hard">×§×©×”</button>
    </div>
  </section>

  <div id="confettiContainer" class="confetti-container" aria-hidden="true"></div>

  <script>
    (function () {
      const welcome = document.getElementById('welcome');
      const game = document.getElementById('game');
      const correctScreen = document.getElementById('correctScreen');
      const wrongScreen = document.getElementById('wrongScreen');
      const exerciseText = document.getElementById('exerciseText');
      const answersContainer = document.getElementById('answersContainer');
      const streakCount = document.getElementById('streakCount');
      const btnStart = document.getElementById('btnStart');
      const btnNextCorrect = document.getElementById('btnNextCorrect');
      const btnNextWrong = document.getElementById('btnNextWrong');
      const confettiContainer = document.getElementById('confettiContainer');
      const timerBox = document.getElementById('timerBox');
      const timerNum = document.getElementById('timerNum');

      let streak = 0;
      let currentAnswer = 0;
      let currentOptions = [];
      let audioCtx = null;
      let timerEnabled = false;
      let timerInterval = null;
      let timerSeconds = 30;
      let difficulty = 'medium';

      function updateTimerUI() {
        document.querySelectorAll('.timer-toggle').forEach(function (btn) {
          btn.textContent = timerEnabled ? 'â± ×˜×™×™××¨: ×¤×¢×™×œ' : 'â± ×”×•×¡×£ ×˜×™×™××¨';
          btn.classList.toggle('on', timerEnabled);
          btn.setAttribute('aria-pressed', timerEnabled);
        });
document.querySelectorAll('.timer-duration').forEach(function (sel) {
        sel.value = String(timerSeconds);
        sel.classList.toggle('hidden', !timerEnabled);
      });
      }

      function updateDifficultyUI() {
        document.querySelectorAll('.difficulty-btn').forEach(function (btn) {
          btn.classList.toggle('active', btn.getAttribute('data-level') === difficulty);
        });
      }

      function getAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
      }

      function playTone(freq, start, duration, type) {
        try {
          var ctx = getAudio();
          var osc = ctx.createOscillator();
          var gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = type || 'sine';
          gain.gain.setValueAtTime(0.15, start);
          gain.gain.exponentialRampToValueAtTime(0.01, start + duration);
          osc.start(start);
          osc.stop(start + duration);
        } catch (e) {}
      }

      function soundCorrect() {
        try {
          var t = getAudio().currentTime;
          playTone(523, t, 0.12, 'sine');
          playTone(659, t + 0.12, 0.12, 'sine');
          playTone(784, t + 0.24, 0.2, 'sine');
        } catch (e) {}
      }

      function soundWrong() {
        try {
          var t = getAudio().currentTime;
          playTone(200, t, 0.15, 'sine');
          playTone(180, t + 0.15, 0.2, 'sine');
        } catch (e) {}
      }

      function soundTap() {
        try {
          var t = getAudio().currentTime;
          playTone(400, t, 0.06, 'sine');
        } catch (e) {}
      }

      function rand(max) {
        return Math.floor(Math.random() * (max + 1));
      }

      function getMaxForDifficulty() {
        if (difficulty === 'easy') return 50;
        if (difficulty === 'hard') return 200;
        return 200;
      }

      function genExercise() {
        var maxVal = getMaxForDifficulty();
        var multMax = difficulty === 'easy' ? 5 : difficulty === 'hard' ? 14 : 10;
        var offsetRange = difficulty === 'easy' ? 10 : difficulty === 'hard' ? 25 : 20;
        const op = rand(2);
        let a, b, result;
        if (op === 0) {
          a = rand(maxVal - 1) + 1;
          b = rand(maxVal - a);
          result = a + b;
          exerciseText.textContent = a + ' + ' + b;
        } else if (op === 1) {
          var larger = rand(maxVal - 1) + 1;
          var smaller = rand(larger);
          result = larger - smaller;
          exerciseText.textContent = larger + ' âˆ’ ' + smaller;
        } else {
          a = rand(multMax - 1) + 1;
          b = rand(multMax - 1) + 1;
          result = a * b;
          exerciseText.textContent = a + ' Ã— ' + b;
        }
        currentAnswer = result;
        const numOptions = 3 + rand(1);
        const options = new Set([result]);
        var optionsMax = difficulty === 'easy' ? 50 : 200;
        while (options.size < numOptions) {
          const offset = rand(offsetRange * 2) - offsetRange;
          if (offset !== 0) options.add(Math.max(0, Math.min(optionsMax, result + offset)));
        }
        currentOptions = Array.from(options).sort(function (x, y) { return x - y; });
        return currentOptions;
      }

      function showScreen(screenEl) {
        document.querySelectorAll('.screen').forEach(function (s) { s.classList.remove('active'); });
        screenEl.classList.add('active');
        document.body.classList.remove('correct', 'wrong');
        stopTimer();
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      function startTimer() {
        stopTimer();
        if (!timerEnabled) {
          timerBox.classList.add('hidden');
          return;
        }
        timerBox.classList.remove('hidden');
        timerBox.classList.remove('low', 'urgent');
        var sec = timerSeconds;
        timerNum.textContent = sec;
        timerInterval = setInterval(function () {
          sec--;
          timerNum.textContent = sec;
          timerBox.classList.remove('low', 'urgent');
          if (sec <= 5) timerBox.classList.add('urgent');
          else if (sec <= 10) timerBox.classList.add('low');
          if (sec <= 0) {
            stopTimer();
            soundWrong();
            streak = 0;
            streakCount.textContent = '0';
            document.body.classList.add('wrong');
            setTimeout(function () {
              showScreen(wrongScreen);
            }, 600);
          }
        }, 1000);
      }

      function runConfetti() {
        confettiContainer.innerHTML = '';
        var colors = ['#ffd93d', '#ff9f43', '#6bcb77', '#4d96ff', '#ff6b9d', '#c44569', '#38ef7d', '#f093fb'];
        var shapes = ['square', 'circle', 'rect'];
        for (var i = 0; i < 75; i++) {
          var p = document.createElement('div');
          p.className = 'confetti-piece ' + shapes[rand(shapes.length - 1)];
          p.style.left = rand(100) + '%';
          p.style.background = colors[rand(colors.length - 1)];
          p.style.animationDelay = (rand(300) / 1000) + 's';
          p.style.animationDuration = (2.8 + rand(700) / 1000) + 's';
          confettiContainer.appendChild(p);
        }
        setTimeout(function () { confettiContainer.innerHTML = ''; }, 4000);
      }

      function renderGame() {
        const options = genExercise();
        answersContainer.innerHTML = '';
        options.forEach(function (val) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'answer-btn';
          btn.textContent = val;
          btn.addEventListener('click', function () {
            stopTimer();
            if (val === currentAnswer) {
              soundCorrect();
              streak++;
              streakCount.textContent = streak;
              document.body.classList.add('correct');
              showScreen(correctScreen);
              runConfetti();
            } else {
              soundWrong();
              streak = 0;
              streakCount.textContent = '0';
              btn.classList.add('wrong-choice');
              document.body.classList.add('wrong');
              setTimeout(function () {
                showScreen(wrongScreen);
              }, 600);
            }
          });
          answersContainer.appendChild(btn);
        });
      }

      document.querySelectorAll('.timer-toggle').forEach(function (btn) {
        btn.addEventListener('click', function () {
          timerEnabled = !timerEnabled;
          if (!timerEnabled) stopTimer();
          updateTimerUI();
        });
      });
      document.querySelectorAll('.timer-duration').forEach(function (sel) {
        sel.addEventListener('change', function () {
          timerSeconds = parseInt(sel.value, 10);
          updateTimerUI();
          if (timerEnabled && timerInterval) {
            stopTimer();
            startTimer();
          }
        });
      });
      updateTimerUI();
      updateDifficultyUI();

      document.querySelectorAll('.difficulty-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          difficulty = btn.getAttribute('data-level');
          updateDifficultyUI();
        });
      });

      btnStart.addEventListener('click', function () {
        soundTap();
        streak = 0;
        streakCount.textContent = '0';
        renderGame();
        showScreen(game);
        startTimer();
      });

      btnNextCorrect.addEventListener('click', function () {
        soundTap();
        renderGame();
        showScreen(game);
        startTimer();
      });

      btnNextWrong.addEventListener('click', function () {
        soundTap();
        showScreen(game);
        startTimer();
      });

      document.querySelectorAll('.btn-restart').forEach(function (btn) {
        btn.addEventListener('click', function () {
          soundTap();
          stopTimer();
          streak = 0;
          streakCount.textContent = '0';
          showScreen(welcome);
        });
      });

      renderGame();
    })();
  </script>
</body>
</html>
